---
title: Kubernetes集群安装
cover: https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220422222353435.png
author: 
  nick: hanggle
  link: https://www.github.com/hanggle
subtitle: Kubernetes是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）,Kubernetes提供了应用部署，规划，更新，维护的一种机制。

tags: 
    - k8s
categories: CI/CD
date: 2022-5-2 23:52:04
---

## 安装Docker

https://hanggle.github.io/2022/05/04/Docker-1/

https://docs.docker.com/engine/install/centos/



# 安装K8s

>- 一台兼容的 Linux 主机。Kubernetes 项目为基于 Debian 和 Red Hat 的 Linux 发行版以及一些不提供包管理器的发行版提供通用的指令
>- 每台机器 2 GB 或更多的 RAM （如果少于这个数字将会影响你应用的运行内存)
>- 2 CPU 核或更多
>- 集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)
>
>- - **设置防火墙放行规则**
>
>- 节点之中不可以有重复的主机名、MAC 地址或 product_uuid。请参见[这里](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address)了解更多详细信息。
>
>- - **设置不同hostname**
>
>- 开启机器上的某些端口。请参见[这里](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports) 了解更多详细信息。
>
>- - **内网互信**
>
>- 禁用交换分区。为了保证 kubelet 正常工作，你 **必须** 禁用交换分区。
>
>- - **永久关闭**



### 1、基本环境

> 每个机器使用内网ip互通
>
> 每个机器配置自己的hostname，不能用localhost

```shell
#设置每个机器自己的hostname
hostnamectl set-hostname xxx

# 将 SELinux 设置为 permissive 模式（相当于将其禁用）
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

#关闭swap
swapoff -a  
sed -ri 's/.*swap.*/#&/' /etc/fstab

#允许 iptables 检查桥接流量
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sudo sysctl --system
```

查看防火墙状态

```
systemctl status firewalld.service
```

关闭防火墙

```
systemctl stop firewalld.service
```

永久关闭防火墙

```
systemctl disable firewalld.service
```

### 2、安装kubelet、kubeadm、kubectl

```
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF


sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes

sudo systemctl enable --now kubelet
```



### 3、下载各个节点需要使用的镜像

```shell
sudo tee ./images.sh <<-'EOF'
#!/bin/bash
images=(
kube-apiserver:v1.20.9
kube-proxy:v1.20.9
kube-controller-manager:v1.20.9
kube-scheduler:v1.20.9
coredns:1.7.0
etcd:3.4.13-0
pause:3.2
)
for imageName in ${images[@]} ; do
docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/$imageName
done
EOF
   
chmod +x ./images.sh && ./images.sh
```



### 4、初始化主节点

```
#所有机器添加master域名映射，以下需要修改为自己的
echo "master节点ip  k8s-master" >> /etc/hosts



#主节点初始化
kubeadm init \
--apiserver-advertise-address=master节点ip \
--control-plane-endpoint=k8s-mastert \
--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \
--kubernetes-version v1.20.9 \
--service-cidr=10.96.0.0/16 \
--pod-network-cidr=192.168.0.0/16


```

**所有网络范围不重叠**

执行成功后会出现

> Your Kubernetes control-plane has initialized successfully!
>
> To start using your cluster, you need to run the following as a regular user:
>
>   mkdir -p $HOME/.kube
>   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
>   sudo chown $(id -u):$(id -g) $HOME/.kube/config
>
> Alternatively, if you are the root user, you can run:
>
>   export KUBECONFIG=/etc/kubernetes/admin.conf
>
> You should now deploy a pod network to the cluster.
> Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
>   https://kubernetes.io/docs/concepts/cluster-administration/addons/
>
> You can now join any number of control-plane nodes by copying certificate authorities
> and service account keys on each node and then running the following as root:
>
>   kubeadm join k8s-master:6443 --token taooyi.bbe209y4ues2dlow \
>     --discovery-token-ca-cert-hash sha256:c3471ce02497152f05865ae214f23566d20763ac4f6e4fb1350f814cf651f6df \
>     --control-plane 
>
> Then you can join any number of worker nodes by running the following on each as root:
>
> kubeadm join k8s-master:6443 --token taooyi.bbe209y4ues2dlow \
>     --discovery-token-ca-cert-hash sha256:c3471ce02497152f05865ae214f23566d20763ac4f6e4fb1350f814cf651f6df 

官方说是为了安全，初始化token后会在24小时候会被master删除

仔细查看日志 按照提示执行

```shell
mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  
export KUBECONFIG=/etc/kubernetes/admin.conf
```

![image-20220508100440328](https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220508100440328.png)

### 5、安装网络组件

可以选择其它的网络插件，此处使用 [calico官网](https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-more-than-50-nodes)

```
curl https://docs.projectcalico.org/manifests/calico.yaml -O

kubectl apply -f calico.yaml
```

等待所有任务都是running后。执行下一步

> 如果pod一直未启动成功，pod会一直进行重试，此时应查看pod的执行日志排查问题
>
> 如果ip分配不合理，此处配置会报错，ip被占用

### 6、加入node节点

此处命令为安装后打印的提示信息

```
kubeadm join k8s-master:6443 --token taooyi.bbe209y4ues2dlow \
    --discovery-token-ca-cert-hash sha256:c3471ce02497152f05865ae214f23566d20763ac4f6e4fb1350f814cf651f6df 
```



### 7、验证集群状态

```
  kubectl get nodes
```





## 命令汇总

```shell
# 重新生成token
kubeadm token create  --print-join-command

# 查看token
kubeadm token list

#查看集群所有节点
kubectl get nodes

#根据配置文件，给集群创建资源
kubectl apply -f xxxx.yaml

#根据配置文件，删除已创建资源
kubectl delete -f xxxx.yaml

#查看集群部署了哪些pod
kubectl get pods -A

#查看集群部署的pod的详细信息（部署节点）
kubectl get pods -A -o wide

# 查看名称空间kube-system下pod为calico-node-jf8l4的安装描述信息。
kubectl describe pod -n kube-system  calico-node-jf8l4 


```



## 可能遇到的问题

> [ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1                                                               
>
> [preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`                                                                  
>
> To see the stack trace of this error execute with --v=5 or higher



执行

```
sysctl -w net.ipv4.ip_forward=1
```









## 其它

### Dashboard

DashBoard是kubernetes官方提供的可视化界面 https://github.com/kubernetes/dashboard

``` shell
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml
```

设置访问端口，改为外网可以访问

```
kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard

> type: ClusterIP 改为 type: NodePort
```



```
kubectl get svc -A |grep kubernetes-dashboard
## 找到端口，在安全组放行
```



![image-20220508092020431](https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220508092020431.png)

>  虚拟机第一次安装显示成功，但是未创建pod，重启虚拟机后再次安装可以安装成功



访问： https://集群任意IP:端口

![image-20220508092313484](https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220508092313484.png)

#### 创建访问账号

```shell
#创建访问账号，准备一个yaml文件； vi dash.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
```

 执行

```shell
kubectl apply -f dash.yaml
```

#### 获取访问令牌

```
kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath="{.secrets[0].name}") -o go-template="{{.data.token | base64decode}}"
```

![image-20220508092242153](https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220508092242153.png)

```
# token
eyJhbGciOiJSUzI1NiIsImtpZCI6InF4dVRiRGFTSlRpVVU4NzFwa0dLRURjWEJXdlN6Q3VXMEh1NTJjTmU4Z3cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTlmMmRqIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI0NzNkZGEwMC1mYWI1LTQ2MTktYTIwNS1lOWNjZDZkN2RiMGMiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.L0CbPy5sFKYqQO9j6sMPrfEyWjgDh_36xaM6jYO7VrS9n14a8Icvl4B0WUYznnqNzBppFfSDI25riEgtkCjTz2Ys3g0Z6heSf-LvDCiWTO1Q5a2McBkmFl55JqBdMOxyeX6VqE7K2z-3vf-tsNLWbpHFH5470O4Q1Q_FNNYOkuZI1e_41iEROcbdfuQEIiIe034h5Whx-jkVB4KQxh2HZyDy-rsbZmNZha57_vVMJCNcwGTC3aUhNcQ-qIltQyiBJIVhRIPtLkpMlGnGSHobXT_tWDd_wl9PbVyONzccwYHNMG_DCTRkDPB8CoHPICRSl2sa1MF6x4-Gxt6_2gKX4g
```

输入token 登录

![image-20220508092341384](https://hanggle-blog.oss-cn-hangzhou.aliyuncs.com/article/image-20220508092341384.png)



### 安装过程中的问题

> Initializing csrf token from kubernetes-dashboard-csrf secret panic: Get https://ip:443/api/v1/namespaces/kubernetes-dashboard/secrets/kubernetes-dashboard-csrf: dial tcp ip: i/o timeout

具体原因未找到，可以采用将dashboard部署在master节点来解决。可以现将子节点关闭，部署后再启动。也可以修改recommended.yaml文件 ，指定部署在master节点

